<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta content="text/html; charset=utf-8" http-equiv="Content-Type" />

  <title>Class: Document</title>

  <link rel="stylesheet" href="./rdoc.css" type="text/css" media="screen" />

  <script src="./js/jquery.js" type="text/javascript" charset="utf-8"></script>
  <script src="./js/thickbox-compressed.js" type="text/javascript" charset="utf-8"></script>
  <script src="./js/quicksearch.js" type="text/javascript" charset="utf-8"></script>
  <script src="./js/darkfish.js" type="text/javascript" charset="utf-8"></script>

</head>
<body id="top" class="class">

  <div id="metadata">
    <div id="home-metadata">
      <div id="home-section" class="section">
        <h3 class="section-header">
          <a href="./index.html">Home</a>
          <a href="./index.html#classes">Classes</a>
          <a href="./index.html#methods">Methods</a>
        </h3>
      </div>
    </div>

    <div id="file-metadata">
      <div id="file-list-section" class="section">
        <h3 class="section-header">In Files</h3>
        <div class="section-body">
          <ul>
          
            <li><a href="./app/models/document_rb.html?TB_iframe=true&amp;height=550&amp;width=785"
              class="thickbox" title="app/models/document.rb">app/models/document.rb</a></li>
          
          </ul>
        </div>
      </div>

      
    </div>

    <div id="class-metadata">
      
      <!-- Parent Class -->
      <div id="parent-class-section" class="section">
        <h3 class="section-header">Parent</h3>
        
        <p class="link">ActiveRecord::Base</p>
        
      </div>
      

      

      

      
      <!-- Method Quickref -->
      <div id="method-list-section" class="section">
        <h3 class="section-header">Methods</h3>
        <ul class="link-list">
          
          <li><a href="#method-c-search_document">::search_document</a></li>
          
          <li><a href="#method-c-search_location">::search_location</a></li>
          
          <li><a href="#method-c-search_people">::search_people</a></li>
          
          <li><a href="#method-c-simple_search">::simple_search</a></li>
          
          <li><a href="#method-i-people_list">#people_list</a></li>
          
        </ul>
      </div>
      

      
    </div>

    <div id="project-metadata">
      
      
      <div id="fileindex-section" class="section project-section">
        <h3 class="section-header">Files</h3>
        <ul>
        
          <li class="file"><a href="./doc/README_FOR_APP.html">README_FOR_APP</a></li>
        
        </ul>
      </div>
      

      <div id="classindex-section" class="section project-section">
        <h3 class="section-header">Class/Module Index
          <span class="search-toggle"><img src="./images/find.png"
            height="16" width="16" alt="[+]"
            title="show/hide quicksearch" /></span></h3>
        <form action="#" method="get" accept-charset="utf-8" class="initially-hidden">
        <fieldset>
          <legend>Quicksearch</legend>
          <input type="text" name="quicksearch" value=""
            class="quicksearch-field" />
        </fieldset>
        </form>

        <ul class="link-list">
        
          <li><a href="./ApplicationController.html">ApplicationController</a></li>
        
          <li><a href="./ApplicationHelper.html">ApplicationHelper</a></li>
        
          <li><a href="./AttributeDocument.html">AttributeDocument</a></li>
        
          <li><a href="./AttributeType.html">AttributeType</a></li>
        
          <li><a href="./Document.html">Document</a></li>
        
          <li><a href="./DocumentStatus.html">DocumentStatus</a></li>
        
          <li><a href="./DocumentStatusesController.html">DocumentStatusesController</a></li>
        
          <li><a href="./DocumentStatusesHelper.html">DocumentStatusesHelper</a></li>
        
          <li><a href="./DocumentType.html">DocumentType</a></li>
        
          <li><a href="./DocumentsController.html">DocumentsController</a></li>
        
          <li><a href="./DocumentsHelper.html">DocumentsHelper</a></li>
        
          <li><a href="./EventType.html">EventType</a></li>
        
          <li><a href="./HomeController.html">HomeController</a></li>
        
          <li><a href="./HomeHelper.html">HomeHelper</a></li>
        
          <li><a href="./Location.html">Location</a></li>
        
          <li><a href="./Person.html">Person</a></li>
        
          <li><a href="./PersonEvent.html">PersonEvent</a></li>
        
          <li><a href="./User.html">User</a></li>
        
          <li><a href="./UserSession.html">UserSession</a></li>
        
          <li><a href="./UserSessionsController.html">UserSessionsController</a></li>
        
          <li><a href="./UserSessionsHelper.html">UserSessionsHelper</a></li>
        
          <li><a href="./UsersController.html">UsersController</a></li>
        
          <li><a href="./UsersHelper.html">UsersHelper</a></li>
        
        </ul>
        <div id="no-class-search-results" style="display: none;">No matching classes.</div>
      </div>

      
    </div>
  </div>

  <div id="documentation">
    <h1 class="class">Document</h1>

    <div id="description" class="description">
      
    </div><!-- description -->

    
    
    
    <div id="5Buntitled-5D" class="documentation-section">
      

      

      

      

      <!-- Methods -->
      
      <div id="public-class-method-details" class="method-section section">
        <h3 class="section-header">Public Class Methods</h3>

      
        <div id="search_document-method" class="method-detail ">
          <a name="method-c-search_document"></a>

          
          <div class="method-heading">
            <span class="method-name">search_document</span><span
              class="method-args">(search_params)</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
          

          <div class="method-description">
            
            
            

            
            <div class="method-source-code" id="search_document-source">
<pre>
<span class="ruby-comment"># File app/models/document.rb, line 176</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">search_document</span>(<span class="ruby-identifier">search_params</span>)
  <span class="ruby-identifier">condition</span>  = <span class="ruby-string">&quot;&quot;</span>

  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">search_params</span>[<span class="ruby-value">:date_from</span>].<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">search_params</span>[<span class="ruby-value">:date_to</span>].<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span>
     <span class="ruby-identifier">search_params</span>[<span class="ruby-value">:date_from</span>] <span class="ruby-operator">!=</span> <span class="ruby-string">'yyyy'</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">search_params</span>[<span class="ruby-value">:date_to</span>] <span class="ruby-operator">!=</span> <span class="ruby-string">'yyyy'</span>
    <span class="ruby-identifier">date_from</span> = <span class="ruby-identifier">search_params</span>[<span class="ruby-value">:date_from</span>].<span class="ruby-identifier">to_i</span>
    <span class="ruby-identifier">date_to</span>   = <span class="ruby-identifier">search_params</span>[<span class="ruby-value">:date_to</span>].<span class="ruby-identifier">to_i</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">search_params</span>[<span class="ruby-value">:date_other_from</span>].<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">search_params</span>[<span class="ruby-value">:date_other_to</span>].<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span>
     <span class="ruby-identifier">search_params</span>[<span class="ruby-value">:date_other_from</span>] <span class="ruby-operator">!=</span> <span class="ruby-string">'yyy'</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">search_params</span>[<span class="ruby-value">:date_other_to</span>] <span class="ruby-operator">!=</span> <span class="ruby-string">'yy'</span>
    <span class="ruby-identifier">date_now</span>   = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">year</span>.<span class="ruby-identifier">to_i</span>
    <span class="ruby-identifier">date_other_from</span> = <span class="ruby-identifier">date_now</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">search_params</span>[<span class="ruby-value">:date_other_from</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">search_params</span>[<span class="ruby-value">:date_other_to</span>].<span class="ruby-identifier">to_i</span>
    <span class="ruby-identifier">date_other_to</span>   = <span class="ruby-identifier">date_now</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">search_params</span>[<span class="ruby-value">:date_other_from</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">search_params</span>[<span class="ruby-value">:date_other_to</span>].<span class="ruby-identifier">to_i</span>
  <span class="ruby-keyword">end</span>
      
  <span class="ruby-identifier">condition</span> <span class="ruby-operator">+=</span> <span class="ruby-node">&quot;documents.document_type_id = '#{search_params[:document_type_id]}' AND &quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">search_params</span>[<span class="ruby-value">:document_type_id</span>].<span class="ruby-identifier">blank?</span>
  <span class="ruby-identifier">condition</span> <span class="ruby-operator">+=</span> <span class="ruby-node">&quot;documents.document_status_id = '#{search_params[:document_status_id]}' AND &quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">search_params</span>[<span class="ruby-value">:document_status_id</span>].<span class="ruby-identifier">blank?</span>
  <span class="ruby-identifier">condition</span> <span class="ruby-operator">+=</span> <span class="ruby-node">&quot;documents.title = '#{search_params[:document_title]}' AND &quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">search_params</span>[<span class="ruby-value">:document_title</span>].<span class="ruby-identifier">blank?</span>
  <span class="ruby-identifier">condition</span> <span class="ruby-operator">+=</span> <span class="ruby-node">&quot;attribute_types.name = 'publisher' AND attribute_documents.value = '#{search_params[:document_publisher]}' AND &quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">search_params</span>[<span class="ruby-value">:document_publisher</span>].<span class="ruby-identifier">blank?</span>
  <span class="ruby-identifier">condition</span> <span class="ruby-operator">+=</span> <span class="ruby-node">&quot;attribute_types.name = 'author' AND attribute_documents.value = '#{search_params[:document_author]}' AND &quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">search_params</span>[<span class="ruby-value">:document_author</span>].<span class="ruby-identifier">blank?</span>


  <span class="ruby-identifier">condition</span> <span class="ruby-operator">+=</span> <span class="ruby-node">&quot;(extract(year FROM person_events.date_event) &gt;= '#{date_from}'
                AND extract(year FROM person_events.date_event) &lt;= '#{date_to}') AND &quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">date_from</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">date_to</span>.<span class="ruby-identifier">blank?</span>

  <span class="ruby-identifier">condition</span> <span class="ruby-operator">+=</span> <span class="ruby-node">&quot;(extract(year FROM person_events.date_event) &gt;= '#{date_other_from}' AND
                extract(year FROM person_events.date_event) &lt;= '#{date_other_to}') AND &quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">date_other_from</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">date_other_to</span>.<span class="ruby-identifier">blank?</span>


  <span class="ruby-identifier">puts</span> <span class="ruby-identifier">condition</span>
  <span class="ruby-keyword">unless</span> <span class="ruby-identifier">condition</span>.<span class="ruby-identifier">blank?</span>
    <span class="ruby-identifier">condition</span> <span class="ruby-operator">+=</span> <span class="ruby-string">&quot; 1 = 1 &quot;</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">find_by_sql</span>(<span class="ruby-node">&quot;SELECT DISTINCT documents.* FROM documents
                      LEFT JOIN users ON users.id = documents.user_id
                      LEFT JOIN document_types ON document_types.id = documents.document_type_id
                      LEFT JOIN document_statuses ON document_statuses.id = documents.document_status_id   
                      LEFT JOIN attribute_documents ON attribute_documents.document_id = documents.id
                      LEFT JOIN attribute_types ON attribute_types.id = attribute_documents.attribute_type_id
                      LEFT JOIN people ON people.document_id = documents.id
                      LEFT JOIN person_events ON person_events.person_id = people.id
                      LEFT JOIN event_types ON event_types.id = person_events.event_type_id
                      LEFT JOIN locations ON locations.document_id = documents.id
                      WHERE #{condition} &quot;</span>)

  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
            </div><!-- search_document-source -->
            
          </div>

          

          
        </div><!-- search_document-method -->

      
        <div id="search_location-method" class="method-detail ">
          <a name="method-c-search_location"></a>

          
          <div class="method-heading">
            <span class="method-name">search_location</span><span
              class="method-args">(search_params)</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
          

          <div class="method-description">
            
            
            

            
            <div class="method-source-code" id="search_location-source">
<pre>
<span class="ruby-comment"># File app/models/document.rb, line 129</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">search_location</span>(<span class="ruby-identifier">search_params</span>)

  
  <span class="ruby-identifier">condition_str</span>  = <span class="ruby-string">&quot;&quot;</span>

  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">search_params</span>[<span class="ruby-value">:date_from</span>].<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">search_params</span>[<span class="ruby-value">:date_to</span>].<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span>
     <span class="ruby-identifier">search_params</span>[<span class="ruby-value">:date_from</span>] <span class="ruby-operator">!=</span> <span class="ruby-string">'yyyy'</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">search_params</span>[<span class="ruby-value">:date_to</span>] <span class="ruby-operator">!=</span> <span class="ruby-string">'yyyy'</span>
    <span class="ruby-identifier">date_from</span> = <span class="ruby-identifier">search_params</span>[<span class="ruby-value">:date_from</span>].<span class="ruby-identifier">to_i</span>
    <span class="ruby-identifier">date_to</span>   = <span class="ruby-identifier">search_params</span>[<span class="ruby-value">:date_to</span>].<span class="ruby-identifier">to_i</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">search_params</span>[<span class="ruby-value">:date_other_from</span>].<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">search_params</span>[<span class="ruby-value">:date_other_to</span>].<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span>
     <span class="ruby-identifier">search_params</span>[<span class="ruby-value">:date_other_from</span>] <span class="ruby-operator">!=</span> <span class="ruby-string">'yyy'</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">search_params</span>[<span class="ruby-value">:date_other_to</span>] <span class="ruby-operator">!=</span> <span class="ruby-string">'yy'</span>
    <span class="ruby-identifier">date_now</span>   = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">year</span>.<span class="ruby-identifier">to_i</span>
    <span class="ruby-identifier">date_other_from</span> = <span class="ruby-identifier">date_now</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">search_params</span>[<span class="ruby-value">:date_other_from</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">search_params</span>[<span class="ruby-value">:date_other_to</span>].<span class="ruby-identifier">to_i</span>
    <span class="ruby-identifier">date_other_to</span>   = <span class="ruby-identifier">date_now</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">search_params</span>[<span class="ruby-value">:date_other_from</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">search_params</span>[<span class="ruby-value">:date_other_to</span>].<span class="ruby-identifier">to_i</span>
  <span class="ruby-keyword">end</span>

  
  <span class="ruby-identifier">condition_str</span> <span class="ruby-operator">+=</span> <span class="ruby-node">&quot;(locations.town = '#{search_params[:city]}' OR person_events.town = '#{search_params[:city]}') AND &quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">search_params</span>[<span class="ruby-value">:city</span>].<span class="ruby-identifier">blank?</span>
  <span class="ruby-identifier">condition_str</span> <span class="ruby-operator">+=</span> <span class="ruby-node">&quot;(locations.county = '#{search_params[:county]}' OR person_events.county = '#{search_params[:county]}') AND &quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">search_params</span>[<span class="ruby-value">:county</span>].<span class="ruby-identifier">blank?</span>
  <span class="ruby-identifier">condition_str</span> <span class="ruby-operator">+=</span> <span class="ruby-node">&quot;(locations.country = '#{search_params[:country]}' OR person_events.country = '#{search_params[:country]}') AND &quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">search_params</span>[<span class="ruby-value">:country</span>].<span class="ruby-identifier">blank?</span>

  <span class="ruby-identifier">condition_str</span> <span class="ruby-operator">+=</span> <span class="ruby-node">&quot;(extract(year FROM person_events.date_event) &gt;= '#{date_from}'
                AND extract(year FROM person_events.date_event) &lt;= '#{date_to}') AND &quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">date_from</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">date_to</span>.<span class="ruby-identifier">blank?</span>

  <span class="ruby-identifier">condition_str</span> <span class="ruby-operator">+=</span> <span class="ruby-node">&quot;(extract(year FROM person_events.date_event) &gt;= '#{date_other_from}' AND
                extract(year FROM person_events.date_event) &lt;= '#{date_other_to}') AND &quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">date_other_from</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">date_other_to</span>.<span class="ruby-identifier">blank?</span>

  <span class="ruby-identifier">puts</span> <span class="ruby-identifier">condition_str</span>
  <span class="ruby-keyword">unless</span> <span class="ruby-identifier">condition_str</span>.<span class="ruby-identifier">blank?</span>
    <span class="ruby-identifier">condition_str</span> <span class="ruby-operator">+=</span> <span class="ruby-string">&quot; 1 = 1 &quot;</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">find_by_sql</span>(<span class="ruby-node">&quot;SELECT DISTINCT documents.* FROM documents
                      LEFT JOIN users ON users.id = documents.user_id
                      LEFT JOIN document_types ON document_types.id = documents.document_type_id
                      LEFT JOIN document_statuses ON document_statuses.id = documents.document_status_id
                      LEFT JOIN attribute_documents ON attribute_documents.document_id = documents.id
                      LEFT JOIN attribute_types ON attribute_types.id = attribute_documents.attribute_type_id
                      LEFT JOIN people ON people.document_id = documents.id
                      LEFT JOIN person_events ON person_events.person_id = people.id
                      LEFT JOIN event_types ON event_types.id = person_events.event_type_id
                      LEFT JOIN locations ON locations.document_id = documents.id
                      WHERE #{condition_str} &quot;</span>)

  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
            </div><!-- search_location-source -->
            
          </div>

          

          
        </div><!-- search_location-method -->

      
        <div id="search_people-method" class="method-detail ">
          <a name="method-c-search_people"></a>

          
          <div class="method-heading">
            <span class="method-name">search_people</span><span
              class="method-args">(search_params)</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
          

          <div class="method-description">
            
            
            

            
            <div class="method-source-code" id="search_people-source">
<pre>
<span class="ruby-comment"># File app/models/document.rb, line 65</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">search_people</span>(<span class="ruby-identifier">search_params</span>)
  <span class="ruby-identifier">search_params</span>[<span class="ruby-value">:date_birth_to</span>] = <span class="ruby-string">'0'</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">search_params</span>[<span class="ruby-value">:date_birth_to</span>] <span class="ruby-operator">==</span> <span class="ruby-string">'yy'</span>
  <span class="ruby-identifier">search_params</span>[<span class="ruby-value">:date_other_to</span>] = <span class="ruby-string">'0'</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">search_params</span>[<span class="ruby-value">:date_other_to</span>] <span class="ruby-operator">==</span> <span class="ruby-string">'yy'</span>
  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">search_params</span>[<span class="ruby-value">:date_birth_from</span>].<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">search_params</span>[<span class="ruby-value">:date_birth_from</span>] <span class="ruby-operator">!=</span> <span class="ruby-string">'yyyy'</span>
    <span class="ruby-identifier">date_birth_from</span> = <span class="ruby-identifier">search_params</span>[<span class="ruby-value">:date_birth_from</span>].<span class="ruby-identifier">to_i</span>
    <span class="ruby-keyword">unless</span> <span class="ruby-identifier">search_params</span>[<span class="ruby-value">:date_birth_to</span>] <span class="ruby-operator">==</span> <span class="ruby-string">'0'</span>
      <span class="ruby-identifier">date_birth_from</span> = <span class="ruby-identifier">search_params</span>[<span class="ruby-value">:date_birth_from</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">search_params</span>[<span class="ruby-value">:date_birth_to</span>].<span class="ruby-identifier">to_i</span>
      <span class="ruby-identifier">date_birth_to</span> = <span class="ruby-identifier">search_params</span>[<span class="ruby-value">:date_birth_from</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">search_params</span>[<span class="ruby-value">:date_birth_to</span>].<span class="ruby-identifier">to_i</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">search_params</span>[<span class="ruby-value">:date_other_from</span>].<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">search_params</span>[<span class="ruby-value">:date_other_to</span>].<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span>
     <span class="ruby-identifier">search_params</span>[<span class="ruby-value">:date_other_from</span>] <span class="ruby-operator">!=</span> <span class="ruby-string">'yyy'</span>
    <span class="ruby-identifier">date_now</span>   = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">year</span>.<span class="ruby-identifier">to_i</span>
    <span class="ruby-identifier">date_other_from</span> = <span class="ruby-identifier">date_now</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">search_params</span>[<span class="ruby-value">:date_other_from</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">search_params</span>[<span class="ruby-value">:date_other_to</span>].<span class="ruby-identifier">to_i</span>
    <span class="ruby-keyword">unless</span> <span class="ruby-identifier">search_params</span>[<span class="ruby-value">:date_other_to</span>] <span class="ruby-operator">==</span> <span class="ruby-string">'0'</span>
      <span class="ruby-identifier">date_other_to</span> = <span class="ruby-identifier">date_now</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">search_params</span>[<span class="ruby-value">:date_other_from</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">search_params</span>[<span class="ruby-value">:date_other_to</span>].<span class="ruby-identifier">to_i</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">search_params</span>[<span class="ruby-value">:date_death</span>].<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">search_params</span>[<span class="ruby-value">:date_death</span>] <span class="ruby-operator">!=</span> <span class="ruby-string">'yyyy'</span>
    <span class="ruby-identifier">date_death</span> = <span class="ruby-identifier">search_params</span>[<span class="ruby-value">:date_death</span>].<span class="ruby-identifier">to_i</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">condition</span>  = <span class="ruby-string">&quot;&quot;</span>
  <span class="ruby-identifier">condition</span> <span class="ruby-operator">+=</span> <span class="ruby-node">&quot;people.name_first = '#{search_params[:firstname]}' AND &quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">search_params</span>[<span class="ruby-value">:firstname</span>].<span class="ruby-identifier">blank?</span>
  <span class="ruby-identifier">condition</span> <span class="ruby-operator">+=</span> <span class="ruby-node">&quot;people.name_last = '#{search_params[:lastname]}' AND &quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">search_params</span>[<span class="ruby-value">:lastname</span>].<span class="ruby-identifier">blank?</span>
  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">date_birth_from</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">date_birth_to</span>.<span class="ruby-identifier">blank?</span>
  <span class="ruby-identifier">condition</span> <span class="ruby-operator">+=</span> <span class="ruby-node">&quot;(extract(year FROM person_events.date_event) &gt;= '#{date_birth_from}'
                AND event_types.name = 'Birth') AND &quot;</span>
  <span class="ruby-identifier">condition</span> <span class="ruby-operator">+=</span> <span class="ruby-node">&quot;(extract(year FROM person_events.date_event) &lt;= '#{date_birth_to}'
                AND event_types.name = 'Birth') AND &quot;</span>
  <span class="ruby-keyword">elsif</span> <span class="ruby-operator">!</span><span class="ruby-identifier">date_birth_from</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">date_birth_to</span>.<span class="ruby-identifier">blank?</span>
    <span class="ruby-identifier">condition</span> <span class="ruby-operator">+=</span> <span class="ruby-node">&quot;(extract(year FROM person_events.date_event) = '#{date_birth_from}'
                AND event_types.name = 'Birth') AND &quot;</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">condition</span> <span class="ruby-operator">+=</span> <span class="ruby-node">&quot;(event_types.name = 'Death' AND extract(year FROM person_events.date_event) = '#{date_death}')
                AND &quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">date_death</span>.<span class="ruby-identifier">blank?</span>
  <span class="ruby-identifier">condition</span> <span class="ruby-operator">+=</span> <span class="ruby-node">&quot;person_events.city = '#{search_params[:city]}' AND &quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">search_params</span>[<span class="ruby-value">:city</span>].<span class="ruby-identifier">blank?</span>
  <span class="ruby-identifier">condition</span> <span class="ruby-operator">+=</span> <span class="ruby-node">&quot;person_events.county = '#{search_params[:county]}' AND &quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">search_params</span>[<span class="ruby-value">:county</span>].<span class="ruby-identifier">blank?</span>
  <span class="ruby-identifier">condition</span> <span class="ruby-operator">+=</span> <span class="ruby-node">&quot;person_events.country = '#{search_params[:country]}' AND &quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">search_params</span>[<span class="ruby-value">:country</span>].<span class="ruby-identifier">blank?</span>
  <span class="ruby-identifier">condition</span> <span class="ruby-operator">+=</span> <span class="ruby-node">&quot;(extract(year FROM person_events.date_event) &gt;= '#{date_other_from}' 
                AND event_types.name &lt;&gt; 'Death' AND event_types.name &lt;&gt; 'Birth') AND &quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">date_other_from</span>.<span class="ruby-identifier">blank?</span>
  <span class="ruby-identifier">condition</span> <span class="ruby-operator">+=</span> <span class="ruby-node">&quot;(extract(year FROM person_events.date_event) &lt;= '#{date_other_to}'
                AND event_types.name &lt;&gt; 'Death' AND event_types.name &lt;&gt; 'Birth') AND &quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">date_other_to</span>.<span class="ruby-identifier">blank?</span>

  <span class="ruby-identifier">puts</span> <span class="ruby-identifier">condition</span>
  
  <span class="ruby-keyword">unless</span> <span class="ruby-identifier">condition</span>.<span class="ruby-identifier">blank?</span>
    <span class="ruby-identifier">condition</span> <span class="ruby-operator">+=</span> <span class="ruby-string">&quot; 1 = 1 &quot;</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">find_by_sql</span>(<span class="ruby-node">&quot;SELECT DISTINCT documents.* FROM documents
                      LEFT JOIN users ON users.id = documents.user_id
                      LEFT JOIN document_types ON document_types.id = documents.document_type_id
                      LEFT JOIN document_statuses ON document_statuses.id = documents.document_status_id
                      LEFT JOIN attribute_documents ON attribute_documents.document_id = documents.id
                      LEFT JOIN attribute_types ON attribute_types.id = attribute_documents.attribute_type_id
                      LEFT JOIN people ON people.document_id = documents.id
                      LEFT JOIN person_events ON person_events.person_id = people.id
                      LEFT JOIN event_types ON event_types.id = person_events.event_type_id
                      WHERE #{condition} &quot;</span>)

  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
            </div><!-- search_people-source -->
            
          </div>

          

          
        </div><!-- search_people-method -->

      
        <div id="simple_search-method" class="method-detail ">
          <a name="method-c-simple_search"></a>

          
          <div class="method-heading">
            <span class="method-name">simple_search</span><span
              class="method-args">(search_param)</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
          

          <div class="method-description">
            
            
            

            
            <div class="method-source-code" id="simple_search-source">
<pre>
<span class="ruby-comment"># File app/models/document.rb, line 25</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">simple_search</span>(<span class="ruby-identifier">search_param</span>)
  <span class="ruby-identifier">condition</span>  = <span class="ruby-string">&quot;&quot;</span>
  <span class="ruby-identifier">condition</span> <span class="ruby-operator">+=</span> <span class="ruby-node">&quot;documents.document_type_id = '#{search_param[:document_type_id]}' OR &quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">search_param</span>[<span class="ruby-value">:document_type_id</span>].<span class="ruby-identifier">blank?</span>
  <span class="ruby-identifier">condition</span> <span class="ruby-operator">+=</span> <span class="ruby-node">&quot;documents.status = '#{search_param[:socument_status_id]}' OR &quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">search_param</span>[<span class="ruby-value">:document_status_id</span>].<span class="ruby-identifier">blank?</span>
  <span class="ruby-identifier">condition</span> <span class="ruby-operator">+=</span> <span class="ruby-node">&quot;documents.title LIKE '%#{search_param[:document_title]}%' OR &quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">search_param</span>[<span class="ruby-value">:document_title</span>].<span class="ruby-identifier">blank?</span>
  <span class="ruby-identifier">condition</span> <span class="ruby-operator">+=</span> <span class="ruby-node">&quot;attribute_types.name = 'publisher' AND attribute_documents.value = '#{search_param[:document_publisher]}' OR &quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">search_param</span>[<span class="ruby-value">:document_publisher</span>].<span class="ruby-identifier">blank?</span>
  <span class="ruby-identifier">condition</span> <span class="ruby-operator">+=</span> <span class="ruby-node">&quot;attribute_types.name = 'author' AND attribute_documents.value = '#{search_param[:document_author]}' OR &quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">search_param</span>[<span class="ruby-value">:document_author</span>].<span class="ruby-identifier">blank?</span>
  <span class="ruby-identifier">condition</span> <span class="ruby-operator">+=</span> <span class="ruby-node">&quot;people.name_first = '#{search_param[:firstname]}' OR &quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">search_param</span>[<span class="ruby-value">:firstname</span>].<span class="ruby-identifier">blank?</span>
  <span class="ruby-identifier">condition</span> <span class="ruby-operator">+=</span> <span class="ruby-node">&quot;people.name_maiden = '#{search_param[:lastname]}' OR &quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">search_param</span>[<span class="ruby-value">:lastname</span>].<span class="ruby-identifier">blank?</span>
  <span class="ruby-identifier">condition</span> <span class="ruby-operator">+=</span> <span class="ruby-node">&quot;YEAR(person_events.date_event) &gt;= '#{search_param[:date_birth_from]}'
                AND YEAR(person_events.date_event) &gt;= '#{search_param[:date_birth_to]}'
                AND event_types.name = 'Birth' OR &quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">search_param</span>[<span class="ruby-value">:date_birth_from</span>].<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">search_param</span>[<span class="ruby-value">:date_birth_to</span>].<span class="ruby-identifier">blank?</span>
  <span class="ruby-identifier">condition</span> <span class="ruby-operator">+=</span> <span class="ruby-node">&quot;person_events.city = '#{search_param[:city]}' AND event_types.name = 'Birth' OR &quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">search_param</span>[<span class="ruby-value">:city</span>].<span class="ruby-identifier">blank?</span>
  <span class="ruby-identifier">condition</span> <span class="ruby-operator">+=</span> <span class="ruby-node">&quot;person_events.county = '#{search_param[:county]}' AND event_types.name = 'Birth' OR &quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">search_param</span>[<span class="ruby-value">:county</span>].<span class="ruby-identifier">blank?</span>
  <span class="ruby-identifier">condition</span> <span class="ruby-operator">+=</span> <span class="ruby-node">&quot;person_events.country = '#{search_param[:country]}' AND event_types.name = 'Birth' OR &quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">search_param</span>[<span class="ruby-value">:country</span>].<span class="ruby-identifier">blank?</span>
  <span class="ruby-identifier">condition</span> <span class="ruby-operator">+=</span> <span class="ruby-node">&quot;YEAR(person_events.date_event) = '#{search_param[:date_death_from]}'
                AND event_types.name = 'Death' OR &quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">search_param</span>[<span class="ruby-value">:date_death_from</span>].<span class="ruby-identifier">blank?</span>
  <span class="ruby-identifier">condition</span> <span class="ruby-operator">+=</span> <span class="ruby-node">&quot;YEAR(person_events.date_event) &gt;= '#{search_param[:date_other_from]}'
                AND YEAR(person_events.date_event) &lt;= '#{search_param[:date_other_to]}'
                AND event_types.name &lt;&gt; 'Birth' AND event_types.name &lt;&gt; 'Death' OR &quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">search_param</span>[<span class="ruby-value">:date_other_from</span>].<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">search_param</span>[<span class="ruby-value">:date_other_to</span>].<span class="ruby-identifier">blank?</span>
  <span class="ruby-identifier">condition</span> <span class="ruby-operator">+=</span> <span class="ruby-node">&quot;locations.city = '#{search_param[:city]}' OR &quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">search_param</span>[<span class="ruby-value">:city</span>].<span class="ruby-identifier">blank?</span>
  <span class="ruby-identifier">condition</span> <span class="ruby-operator">+=</span> <span class="ruby-node">&quot;locations.city = '#{search_param[:county]}' OR &quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">search_param</span>[<span class="ruby-value">:county</span>].<span class="ruby-identifier">blank?</span>
  <span class="ruby-identifier">condition</span> <span class="ruby-operator">+=</span> <span class="ruby-node">&quot;locations.city = '#{search_param[:country]}' OR &quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">search_param</span>[<span class="ruby-value">:country</span>].<span class="ruby-identifier">blank?</span>
  <span class="ruby-keyword">unless</span> <span class="ruby-identifier">condition</span>.<span class="ruby-identifier">blank?</span>
    <span class="ruby-identifier">condition</span> <span class="ruby-operator">+=</span> <span class="ruby-string">&quot; 1 = 0 &quot;</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">find_by_sql</span>(<span class="ruby-node">&quot;SELECT DISTINCT documents.* FROM documents
                      LEFT JOIN users ON users.id = documents.user_id
                      LEFT JOIN document_types ON document_types.id = documents.document_type_id
                      LEFT JOIN document_statuses ON document_statuses.id = documents.document_status_id
                      LEFT JOIN attribute_documents ON attribute_documents.document_id = documents.id
                      LEFT JOIN attribute_types ON attribute_types.id = attribute_documents.attribute_type_id
                      LEFT JOIN people ON people.document_id = documents.id
                      LEFT JOIN person_events ON person_events.person_id = people.id
                      LEFT JOIN event_types ON event_types.id = person_events.event_type_id
                      LEFT JOIN locations ON locations.document_id = documents.id
                      WHERE #{condition} &quot;</span>)
    
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
            </div><!-- simple_search-source -->
            
          </div>

          

          
        </div><!-- simple_search-method -->

      
      </div><!-- public-class-method-details -->
    
      <div id="public-instance-method-details" class="method-section section">
        <h3 class="section-header">Public Instance Methods</h3>

      
        <div id="people_list-method" class="method-detail ">
          <a name="method-i-people_list"></a>

          
          <div class="method-heading">
            <span class="method-name">people_list</span><span
              class="method-args">(firstname, lastname)</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
          

          <div class="method-description">
            
            
            

            
            <div class="method-source-code" id="people_list-source">
<pre>
<span class="ruby-comment"># File app/models/document.rb, line 224</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">people_list</span>(<span class="ruby-identifier">firstname</span>, <span class="ruby-identifier">lastname</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">people</span>.<span class="ruby-identifier">find</span>(<span class="ruby-value">:all</span>, <span class="ruby-value">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-string">&quot;name_first =? AND name_last =? &quot;</span>, <span class="ruby-node">&quot;#{firstname}&quot;</span>, <span class="ruby-node">&quot;#{lastname}&quot;</span>]) <span class="ruby-keyword">unless</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">people</span>.<span class="ruby-identifier">blank?</span>
<span class="ruby-keyword">end</span></pre>
            </div><!-- people_list-source -->
            
          </div>

          

          
        </div><!-- people_list-method -->

      
      </div><!-- public-instance-method-details -->
    
    </div><!-- 5Buntitled-5D -->
  

  </div><!-- documentation -->

  <div id="validator-badges">
    <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
    <p><small>Generated with the <a href="http://deveiate.org/projects/Darkfish-Rdoc/">Darkfish
      Rdoc Generator</a> 2</small>.</p>
  </div>

</body>
</html>

